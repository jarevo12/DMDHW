<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Habits">
    <meta name="description" content="Track your daily morning and evening habits">

    <title>Habit Tracker</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="assets/icons/icon-192.png">
    <link rel="apple-touch-icon" href="assets/icons/icon-192.png">

    <!-- Styles -->
    <link rel="stylesheet" href="css/styles.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
    <!-- App Container -->
    <div id="app">
        <!-- Loading Screen -->
        <div id="loading-screen" class="screen active">
            <div class="loading-content">
                <div class="logo">
                    <span class="logo-icon">&#10003;</span>
                </div>
                <h1>Habit Tracker</h1>
                <div class="loading-spinner"></div>
                <p id="loading-status" style="color: var(--text-secondary); margin-top: 16px; font-size: 0.9rem;"></p>
            </div>
        </div>

        <!-- Auth Screen -->
        <div id="auth-screen" class="screen">
            <div class="auth-content">
                <div class="logo">
                    <span class="logo-icon">&#10003;</span>
                </div>
                <h1>Habit Tracker</h1>
                <p class="subtitle">Track your daily routines</p>

                <form id="auth-form" class="auth-form">
                    <div class="input-group">
                        <label for="email-input" class="input-label">Email</label>
                        <input type="email" id="email-input" placeholder="your@email.com" required autocomplete="email">
                    </div>
                    <div class="input-group" id="password-group">
                        <label for="password-input" class="input-label">Password</label>
                        <input type="password" id="password-input" placeholder="Min 6 characters" autocomplete="current-password" minlength="6" required>
                    </div>

                    <!-- Auth method toggle -->
                    <div class="auth-toggle">
                        <button type="button" id="toggle-auth-method" class="btn-link">
                            <span id="toggle-text">Use magic link instead</span>
                        </button>
                    </div>

                    <!-- Password Auth Buttons -->
                    <div id="password-buttons" style="display: flex; gap: 8px;">
                        <button type="button" class="btn btn-primary" id="signin-btn">
                            <span>Sign In</span>
                        </button>
                        <button type="button" class="btn btn-secondary" id="signup-btn">
                            <span>Sign Up</span>
                        </button>
                    </div>

                    <!-- Magic Link Button -->
                    <button type="submit" class="btn btn-primary" id="magic-link-btn" style="display: none;">
                        <span>Send Magic Link</span>
                    </button>
                </form>

                <div id="auth-message" class="auth-message hidden">
                    <div class="message-icon">&#9993;</div>
                    <h2>Check your email</h2>
                    <p>We sent a magic link to <strong id="sent-email"></strong></p>
                    <button class="btn btn-secondary" id="try-again">Try another email</button>
                </div>

                <div id="auth-error" class="auth-error hidden"></div>
            </div>
        </div>

        <!-- Main App Screen -->
        <div id="main-screen" class="screen">
            <!-- Header -->
            <header class="app-header">
                <button class="btn-icon" id="toggle-calendar" aria-label="Toggle calendar">
                    <span>&#128197;</span>
                </button>
                <button class="btn-icon" id="prev-date" aria-label="Previous day">
                    <span>&lt;</span>
                </button>
                <div class="date-display" id="current-date">
                    <span class="date-text">Today</span>
                    <span class="date-full">Thu, Dec 5, 2025</span>
                </div>
                <button class="btn-icon" id="next-date" aria-label="Next day">
                    <span>&gt;</span>
                </button>
                <button class="btn-icon" id="today-btn" aria-label="Go to today">
                    <span>&#8226;</span>
                </button>
            </header>

            <!-- Calendar Picker -->
            <div id="calendar-picker" class="calendar-picker hidden">
                <div class="calendar-picker-header">
                    <button class="btn-icon" id="prev-month" aria-label="Previous month">
                        <span>&#8249;</span>
                    </button>
                    <span id="calendar-month-year" class="calendar-month-label"></span>
                    <button class="btn-icon" id="next-month" aria-label="Next month">
                        <span>&#8250;</span>
                    </button>
                </div>
                <div class="calendar-weekdays">
                    <span>Su</span>
                    <span>Mo</span>
                    <span>Tu</span>
                    <span>We</span>
                    <span>Th</span>
                    <span>Fr</span>
                    <span>Sa</span>
                </div>
                <div id="calendar-days" class="calendar-days-grid"></div>
            </div>

            <!-- Tab Navigation -->
            <nav class="tab-nav">
                <button class="tab-btn active" data-tab="morning">
                    <span class="tab-icon">&#9788;</span>
                    <span>Morning</span>
                </button>
                <button class="tab-btn" data-tab="evening">
                    <span class="tab-icon">&#9790;</span>
                    <span>Evening</span>
                </button>
            </nav>

            <!-- Habit Lists -->
            <main class="habit-container">
                <div id="morning-habits" class="habit-list active">
                    <!-- Habits will be rendered here -->
                </div>
                <div id="evening-habits" class="habit-list">
                    <!-- Habits will be rendered here -->
                </div>

                <!-- Not Today Section -->
                <div id="not-today-section" class="not-today-section collapsed hidden">
                    <button class="not-today-header" id="toggle-not-today">
                        <span>Not scheduled today</span>
                        <span class="not-today-count">(0)</span>
                        <span class="chevron">&#8250;</span>
                    </button>
                    <div id="not-today-habits">
                        <!-- Unscheduled habits rendered here -->
                    </div>
                </div>
            </main>

            <!-- Progress Bar -->
            <div class="progress-section">
                <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <span class="progress-text" id="progress-text">0/0 completed</span>
            </div>

            <!-- Bottom Navigation -->
            <nav class="bottom-nav" role="navigation" aria-label="Main navigation">
                <button class="nav-btn active" data-view="dashboard" aria-label="Dashboard">
                    <span class="nav-icon" aria-hidden="true">&#9632;</span>
                    <span>Dashboard</span>
                </button>
                <button class="nav-btn" data-view="today" aria-label="Today's habits">
                    <span class="nav-icon" aria-hidden="true">&#10003;</span>
                    <span>Today</span>
                </button>
                <button class="nav-btn" data-view="settings" aria-label="Settings">
                    <span class="nav-icon" aria-hidden="true">&#9881;</span>
                    <span>Settings</span>
                </button>
            </nav>
        </div>

        <!-- Dashboard Screen -->
        <div id="dashboard-screen" class="screen">
            <header class="app-header">
                <h1>Dashboard</h1>
                <select id="month-selector" class="month-select">
                    <!-- Options will be populated dynamically -->
                </select>
            </header>

            <main class="dashboard-content">
                <!-- Summary Cards -->
                <div class="summary-cards">
                    <div class="summary-card">
                        <span class="card-value" id="overall-rate">0%</span>
                        <span class="card-label">Overall</span>
                    </div>
                    <div class="summary-card">
                        <span class="card-value" id="current-streak">0</span>
                        <span class="card-label">Day Streak</span>
                    </div>
                    <div class="summary-card">
                        <span class="card-value" id="best-streak">0</span>
                        <span class="card-label">Best Streak</span>
                    </div>
                </div>

                <!-- Tabs for Morning/Evening -->
                <div class="dashboard-tabs">
                    <button class="dash-tab active" data-type="morning">Morning</button>
                    <button class="dash-tab" data-type="evening">Evening</button>
                </div>

                <!-- Daily Completion Chart -->
                <section class="chart-section">
                    <h2>Daily Completion Trend</h2>
                    <div class="chart-container">
                        <canvas id="completion-chart"></canvas>
                    </div>
                </section>

                <!-- Habit Completion Rates -->
                <section class="chart-section">
                    <h2>Completion Rates</h2>
                    <div id="habit-rates" class="habit-rates">
                        <!-- Bars will be rendered here -->
                    </div>
                </section>

                <!-- Calendar Heatmap -->
                <section class="chart-section">
                    <h2>Calendar</h2>
                    <div id="calendar-heatmap" class="calendar-heatmap">
                        <!-- Calendar will be rendered here -->
                    </div>
                </section>
            </main>

            <!-- Bottom Navigation -->
            <nav class="bottom-nav" role="navigation" aria-label="Main navigation">
                <button class="nav-btn active" data-view="dashboard" aria-label="Dashboard">
                    <span class="nav-icon" aria-hidden="true">&#9632;</span>
                    <span>Dashboard</span>
                </button>
                <button class="nav-btn" data-view="today" aria-label="Today's habits">
                    <span class="nav-icon" aria-hidden="true">&#10003;</span>
                    <span>Today</span>
                </button>
                <button class="nav-btn" data-view="settings" aria-label="Settings">
                    <span class="nav-icon" aria-hidden="true">&#9881;</span>
                    <span>Settings</span>
                </button>
            </nav>
        </div>

        <!-- Settings Screen -->
        <div id="settings-screen" class="screen">
            <header class="app-header">
                <h1>Settings</h1>
            </header>

            <main class="settings-content">
                <!-- Edit Habits Section -->
                <section class="settings-section">
                    <h2>Morning Habits</h2>
                    <div id="edit-morning-habits" class="edit-habit-list">
                        <!-- Editable habits will be rendered here -->
                    </div>
                    <button class="btn btn-add" id="add-morning-habit">
                        <span>+ Add Morning Habit</span>
                    </button>
                </section>

                <section class="settings-section">
                    <h2>Evening Habits</h2>
                    <div id="edit-evening-habits" class="edit-habit-list">
                        <!-- Editable habits will be rendered here -->
                    </div>
                    <button class="btn btn-add" id="add-evening-habit">
                        <span>+ Add Evening Habit</span>
                    </button>
                </section>

                <!-- Account Section -->
                <section class="settings-section">
                    <h2>Account</h2>
                    <div class="account-info">
                        <span id="user-email">user@email.com</span>
                    </div>
                    <button class="btn btn-danger" id="logout-btn">Sign Out</button>
                </section>
            </main>

            <!-- Bottom Navigation -->
            <nav class="bottom-nav" role="navigation" aria-label="Main navigation">
                <button class="nav-btn" data-view="dashboard" aria-label="Dashboard">
                    <span class="nav-icon" aria-hidden="true">&#9632;</span>
                    <span>Dashboard</span>
                </button>
                <button class="nav-btn" data-view="today" aria-label="Today's habits">
                    <span class="nav-icon" aria-hidden="true">&#10003;</span>
                    <span>Today</span>
                </button>
                <button class="nav-btn active" data-view="settings" aria-label="Settings">
                    <span class="nav-icon" aria-hidden="true">&#9881;</span>
                    <span>Settings</span>
                </button>
            </nav>
        </div>

        <!-- Onboarding Screen -->
        <div id="onboarding-screen" class="screen">
            <div class="onboarding-container">
                <!-- Progress Steps -->
                <div class="onboarding-progress">
                    <div class="progress-steps">
                        <span class="step active" data-step="1">1</span>
                        <span class="step" data-step="2">2</span>
                        <span class="step" data-step="3">3</span>
                        <span class="step" data-step="4">4</span>
                    </div>
                    <div class="progress-bar-mini">
                        <div class="progress-fill-mini" id="onboarding-progress-fill"></div>
                    </div>
                </div>

                <!-- Dynamic Content -->
                <div id="onboarding-content" class="onboarding-content">
                    <!-- Content rendered by JS -->
                </div>

                <!-- Navigation -->
                <div class="onboarding-nav">
                    <button class="btn btn-secondary" id="onboarding-back" style="display: none;">Back</button>
                    <button class="btn btn-link" id="onboarding-skip">Skip</button>
                    <button class="btn btn-primary" id="onboarding-next">Get Started</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Schedule Picker Modal -->
    <div id="schedule-modal" class="modal hidden">
        <div class="modal-overlay"></div>
        <div class="modal-content schedule-modal-content">
            <h2>Set Schedule</h2>
            <div class="schedule-type-selector">
                <button class="schedule-type-btn active" data-type="daily">Daily</button>
                <button class="schedule-type-btn" data-type="specific_days">Specific Days</button>
                <button class="schedule-type-btn" data-type="weekly_goal">Weekly Goal</button>
                <button class="schedule-type-btn" data-type="interval">Interval</button>
            </div>
            <div id="schedule-options" class="schedule-options">
                <!-- Dynamic options based on type -->
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="cancel-schedule">Cancel</button>
                <button class="btn btn-primary" id="save-schedule">Save</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Habit Modal -->
    <div id="habit-modal" class="modal hidden">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <h2 id="modal-title">Add Habit</h2>
            <form id="habit-form">
                <input type="hidden" id="habit-id">
                <input type="hidden" id="habit-type">
                <div class="input-group">
                    <input type="text" id="habit-name" placeholder="Habit name" required maxlength="100">
                </div>
                <div class="schedule-field">
                    <label>Schedule</label>
                    <button type="button" class="schedule-picker-btn" id="habit-schedule-btn">Daily</button>
                    <input type="hidden" id="habit-schedule" value='{"type":"daily"}'>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancel-habit">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="modal hidden">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <h2>Delete Habit?</h2>
            <p>This will remove the habit from your list. Historical data will be preserved.</p>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="cancel-delete">Cancel</button>
                <button class="btn btn-danger" id="confirm-delete">Delete</button>
            </div>
        </div>
    </div>

    <!-- Offline Indicator -->
    <div id="offline-indicator" class="offline-indicator hidden">
        <span>You're offline. Changes will sync when connected.</span>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Firebase imports
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, deleteDoc, query, orderBy, onSnapshot, serverTimestamp, writeBatch, connectFirestoreEmulator } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, sendSignInLinkToEmail, isSignInWithEmailLink, signInWithEmailLink, connectAuthEmulator } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        // Check if running on localhost (for emulator usage)
        const USE_EMULATORS = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

        // ========== CONFIGURATION ==========
        const firebaseConfig = {
            apiKey: "AIzaSyAodoB3p7-Cex_Imus3slp_g50Bs0UlBko",
            authDomain: "habit-tracker-f3c23.firebaseapp.com",
            projectId: "habit-tracker-f3c23",
            storageBucket: "habit-tracker-f3c23.firebasestorage.app",
            messagingSenderId: "506442188864",
            appId: "1:506442188864:web:37b25d676ca80c58cd77a5"
        };

        // Default habits
        const DEFAULT_MORNING_HABITS = [
            "Stop alarm without snooze and get up",
            "Go to bathroom and wash face with soap",
            "Eat protein bar/fruit",
            "Look phone (only messages)",
            "5-10 minute stretching & get changed",
            "Go to the gym",
            "Complete scheduled gym session",
            "Go home, prepare breakfast & have shower",
            "Eat breakfast + phone (social/news)",
            "Get changed & go to uni"
        ];

        const DEFAULT_EVENING_HABITS = [
            "Send messages to Adri",
            "Check calendar + gym session next day",
            "Set up alarm & Airplane mode",
            "Prepare bag & clothes for next day",
            "Wash face + apply Roche Possay",
            "Take pill",
            "Read 5-10 pages book",
            "Turn lights off"
        ];

        // ========== GLOBALS ==========
        let app, db, auth;
        let currentUser = null;
        let habits = { morning: [], evening: [] };
        let currentDate = new Date();
        let currentTab = 'morning';
        let currentEntry = null;
        let unsubscribeHabits = null;
        let unsubscribeEntry = null;

        // Calendar state
        let calendarState = {
            isOpen: false,
            currentMonth: new Date().getMonth(),
            currentYear: new Date().getFullYear(),
            entriesData: {}
        };

        // Onboarding state
        let onboardingStep = 1;
        let onboardingHabits = { morning: [], evening: [] };
        let currentScheduleCallback = null;
        let currentScheduleHabit = null;

        // Schedule constants
        const DAY_NAMES = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const DAY_SHORTS = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];

        // ========== SCHEDULE UTILITIES ==========
        function isHabitScheduledForDate(habit, dateString) {
            const schedule = habit.schedule || { type: 'daily' };
            const date = new Date(dateString + 'T00:00:00');
            const dayOfWeek = date.getDay(); // 0-6 (Sun-Sat)

            switch (schedule.type) {
                case 'daily':
                    return true;

                case 'specific_days':
                    return (schedule.days || [0,1,2,3,4,5,6]).includes(dayOfWeek);

                case 'weekly_goal':
                    // For weekly goal, always show - tracking is separate
                    return true;

                case 'interval':
                    const startDate = new Date((schedule.intervalStartDate || dateString) + 'T00:00:00');
                    const diffTime = date - startDate;
                    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                    const interval = schedule.intervalDays || 1;
                    return diffDays >= 0 && diffDays % interval === 0;

                default:
                    return true;
            }
        }

        function getScheduledHabitsForDate(allHabits, dateString) {
            return {
                morning: allHabits.morning.filter(h => isHabitScheduledForDate(h, dateString)),
                evening: allHabits.evening.filter(h => isHabitScheduledForDate(h, dateString))
            };
        }

        function getUnscheduledHabitsForDate(allHabits, dateString) {
            return {
                morning: allHabits.morning.filter(h => !isHabitScheduledForDate(h, dateString)),
                evening: allHabits.evening.filter(h => !isHabitScheduledForDate(h, dateString))
            };
        }

        function getScheduleLabel(schedule) {
            if (!schedule) return 'Daily';

            switch (schedule.type) {
                case 'daily':
                    return 'Daily';
                case 'specific_days':
                    const days = schedule.days || [];
                    if (days.length === 7) return 'Daily';
                    if (days.length === 5 && !days.includes(0) && !days.includes(6)) {
                        return 'Weekdays';
                    }
                    if (days.length === 2 && days.includes(0) && days.includes(6)) {
                        return 'Weekends';
                    }
                    return days.map(d => DAY_NAMES[d].substring(0, 3)).join(', ');
                case 'weekly_goal':
                    return `${schedule.timesPerWeek}x/week`;
                case 'interval':
                    return `Every ${schedule.intervalDays} days`;
                default:
                    return 'Daily';
            }
        }

        function getExpectedCompletionsForMonth(habit, year, month) {
            const schedule = habit.schedule || { type: 'daily' };
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            const isCurrentMonth = year === today.getFullYear() && month === today.getMonth();
            const lastDay = isCurrentMonth ? today.getDate() : daysInMonth;

            let expected = 0;

            for (let day = 1; day <= lastDay; day++) {
                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                if (isHabitScheduledForDate(habit, dateString)) {
                    expected++;
                }
            }

            // For weekly goal, cap at target per week
            if (schedule.type === 'weekly_goal') {
                const weeksInPeriod = Math.ceil(lastDay / 7);
                expected = Math.min(expected, weeksInPeriod * (schedule.timesPerWeek || 3));
            }

            return expected;
        }

        // ========== USER PROFILE ==========
        async function getUserProfile() {
            try {
                const profileRef = doc(db, `users/${currentUser.uid}/profile`, 'main');
                const snapshot = await getDoc(profileRef);
                return snapshot.exists() ? snapshot.data() : null;
            } catch (error) {
                console.error('Error getting user profile:', error);
                return null;
            }
        }

        async function setUserProfile(data) {
            try {
                const profileRef = doc(db, `users/${currentUser.uid}/profile`, 'main');
                await setDoc(profileRef, {
                    ...data,
                    updatedAt: serverTimestamp()
                }, { merge: true });
            } catch (error) {
                console.error('Error setting user profile:', error);
            }
        }

        async function completeOnboarding() {
            await setUserProfile({
                onboardingCompleted: true,
                onboardingCompletedAt: serverTimestamp(),
                createdAt: serverTimestamp()
            });
        }

        // ========== INITIALIZATION ==========
        async function init() {
            updateLoadingStatus('Connecting to server...');

            try {
                // Initialize Firebase
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Connect to emulators if running locally
                if (USE_EMULATORS) {
                    console.log('ðŸ”§ Using Firebase Emulators');
                    connectFirestoreEmulator(db, '127.0.0.1', 8080);
                    connectAuthEmulator(auth, 'http://127.0.0.1:9099');
                }

                updateLoadingStatus('Checking authentication...');

                // Check for email link sign-in
                if (isSignInWithEmailLink(auth, window.location.href)) {
                    await handleEmailLinkSignIn();
                }

                // Listen for auth state changes
                onAuthStateChanged(auth, handleAuthStateChange);

            } catch (error) {
                console.error('Initialization error:', error);
                showError('Failed to connect. Please refresh the page.');
            }
        }

        function updateLoadingStatus(message) {
            const status = document.getElementById('loading-status');
            if (status) status.textContent = message;
        }

        // ========== AUTHENTICATION ==========
        async function handleAuthStateChange(user) {
            currentUser = user;

            if (user) {
                console.log('User signed in:', user.email);
                updateLoadingStatus('Loading your profile...');

                // Check if user has completed onboarding
                const profile = await getUserProfile();

                if (!profile || !profile.onboardingCompleted) {
                    // New user - show onboarding
                    console.log('New user - starting onboarding');
                    initializeOnboarding();
                    showScreen('onboarding');
                } else {
                    // Existing user - normal flow
                    console.log('Existing user - loading dashboard');
                    updateLoadingStatus('Loading your habits...');

                    // Subscribe to data
                    subscribeToHabits();
                    subscribeToEntry();

                    // Update UI
                    document.getElementById('user-email').textContent = user.email;
                    showScreen('dashboard');
                    updateDateDisplay();
                    renderDashboard();
                }

            } else {
                console.log('No user signed in');

                // Cleanup subscriptions
                if (unsubscribeHabits) unsubscribeHabits();
                if (unsubscribeEntry) unsubscribeEntry();

                showScreen('auth');
            }
        }

        async function handleEmailLinkSignIn() {
            let email = localStorage.getItem('emailForSignIn');

            if (!email) {
                email = prompt('Please enter your email to confirm sign-in:');
            }

            if (email) {
                try {
                    await signInWithEmailLink(auth, email, window.location.href);
                    localStorage.removeItem('emailForSignIn');
                    window.history.replaceState(null, '', window.location.pathname);
                } catch (error) {
                    console.error('Email link sign-in error:', error);
                }
            }
        }

        async function sendMagicLink(email) {
            const continueUrl = window.location.origin + window.location.pathname;
            console.log('Sending magic link to:', email);
            console.log('Continue URL:', continueUrl);

            const actionCodeSettings = {
                url: continueUrl,
                handleCodeInApp: true
            };

            try {
                await sendSignInLinkToEmail(auth, email, actionCodeSettings);
                console.log('Magic link sent successfully!');
                localStorage.setItem('emailForSignIn', email);
            } catch (err) {
                console.error('sendSignInLinkToEmail error:', err);
                console.error('Error code:', err.code);
                console.error('Error message:', err.message);
                throw err;
            }
        }

        async function logout() {
            await signOut(auth);
        }

        // ========== HABITS ==========
        async function initializeDefaultHabits() {
            const habitsRef = collection(db, `users/${currentUser.uid}/habits`);
            const snapshot = await getDocs(habitsRef);

            if (!snapshot.empty) return; // Already has habits

            // Add default morning habits
            for (let i = 0; i < DEFAULT_MORNING_HABITS.length; i++) {
                await addDoc(habitsRef, {
                    name: DEFAULT_MORNING_HABITS[i],
                    type: 'morning',
                    order: i + 1,
                    createdAt: serverTimestamp(),
                    archived: false
                });
            }

            // Add default evening habits
            for (let i = 0; i < DEFAULT_EVENING_HABITS.length; i++) {
                await addDoc(habitsRef, {
                    name: DEFAULT_EVENING_HABITS[i],
                    type: 'evening',
                    order: i + 1,
                    createdAt: serverTimestamp(),
                    archived: false
                });
            }
        }

        function subscribeToHabits() {
            const habitsRef = collection(db, `users/${currentUser.uid}/habits`);
            const q = query(habitsRef, orderBy('order', 'asc'));

            unsubscribeHabits = onSnapshot(q, (snapshot) => {
                habits = { morning: [], evening: [] };

                snapshot.forEach((doc) => {
                    const habit = { id: doc.id, ...doc.data() };
                    if (!habit.archived) {
                        habits[habit.type]?.push(habit);
                    }
                });

                renderHabits();
                renderEditableHabits();
                updateProgress();
            });
        }

        async function addHabit(name, type, schedule = { type: 'daily' }) {
            const habitsRef = collection(db, `users/${currentUser.uid}/habits`);
            const maxOrder = habits[type].length > 0
                ? Math.max(...habits[type].map(h => h.order || 0))
                : 0;

            await addDoc(habitsRef, {
                name: name.trim(),
                type: type,
                order: maxOrder + 1,
                schedule: schedule,
                createdAt: serverTimestamp(),
                archived: false
            });
        }

        async function updateHabit(habitId, name, schedule) {
            const habitRef = doc(db, `users/${currentUser.uid}/habits`, habitId);
            await updateDoc(habitRef, {
                name: name.trim(),
                schedule: schedule
            });
        }

        async function deleteHabit(habitId) {
            const habitRef = doc(db, `users/${currentUser.uid}/habits`, habitId);
            await updateDoc(habitRef, { archived: true });
        }

        // ========== ENTRIES ==========
        function formatDate(date) {
            const d = new Date(date);
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        }

        function subscribeToEntry() {
            if (unsubscribeEntry) unsubscribeEntry();

            const dateString = formatDate(currentDate);
            const entryRef = doc(db, `users/${currentUser.uid}/entries`, dateString);

            unsubscribeEntry = onSnapshot(entryRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    currentEntry = { id: docSnapshot.id, ...docSnapshot.data() };
                } else {
                    currentEntry = { morning: [], evening: [] };
                }
                updateHabitCheckmarks();
                updateProgress();
            });
        }

        async function toggleHabit(habitId, type) {
            const dateString = formatDate(currentDate);
            const entryRef = doc(db, `users/${currentUser.uid}/entries`, dateString);

            const completed = currentEntry[type] || [];
            const isCompleted = completed.includes(habitId);

            const newCompleted = isCompleted
                ? completed.filter(id => id !== habitId)
                : [...completed, habitId];

            await setDoc(entryRef, {
                date: dateString,
                [type]: newCompleted
            }, { merge: true });
        }

        // ========== UI RENDERING ==========
        function showScreen(screenName) {
            ['loading', 'auth', 'main', 'dashboard', 'settings', 'onboarding'].forEach(name => {
                const screen = document.getElementById(`${name}-screen`);
                if (screen) {
                    screen.classList.toggle('active', name === screenName);
                }
            });
        }

        // ========== ONBOARDING ==========
        function initializeOnboarding() {
            onboardingStep = 1;
            onboardingHabits = {
                morning: DEFAULT_MORNING_HABITS.map((name, i) => ({
                    name,
                    type: 'morning',
                    order: i + 1,
                    selected: true,
                    schedule: { type: 'daily' }
                })),
                evening: DEFAULT_EVENING_HABITS.map((name, i) => ({
                    name,
                    type: 'evening',
                    order: i + 1,
                    selected: true,
                    schedule: { type: 'daily' }
                }))
            };
            renderOnboardingStep();
        }

        function renderOnboardingStep() {
            updateOnboardingProgress();
            const content = document.getElementById('onboarding-content');

            switch(onboardingStep) {
                case 1:
                    content.innerHTML = renderWelcomeStep();
                    break;
                case 2:
                    content.innerHTML = renderHabitSetupStep('morning');
                    attachHabitSetupListeners('morning');
                    break;
                case 3:
                    content.innerHTML = renderHabitSetupStep('evening');
                    attachHabitSetupListeners('evening');
                    break;
                case 4:
                    content.innerHTML = renderReviewStep();
                    break;
            }

            updateOnboardingNavButtons();
        }

        function updateOnboardingProgress() {
            // Update step indicators
            document.querySelectorAll('.progress-steps .step').forEach((step, index) => {
                step.classList.remove('active', 'completed');
                if (index + 1 < onboardingStep) {
                    step.classList.add('completed');
                } else if (index + 1 === onboardingStep) {
                    step.classList.add('active');
                }
            });

            // Update progress bar
            const progressFill = document.getElementById('onboarding-progress-fill');
            if (progressFill) {
                progressFill.style.width = `${(onboardingStep / 4) * 100}%`;
            }
        }

        function updateOnboardingNavButtons() {
            const backBtn = document.getElementById('onboarding-back');
            const skipBtn = document.getElementById('onboarding-skip');
            const nextBtn = document.getElementById('onboarding-next');

            // Back button
            backBtn.style.display = onboardingStep > 1 ? 'block' : 'none';

            // Skip button - hide on review step
            skipBtn.style.display = onboardingStep < 4 ? 'block' : 'none';

            // Next button text
            if (onboardingStep === 1) {
                nextBtn.textContent = 'Get Started';
            } else if (onboardingStep === 4) {
                nextBtn.textContent = 'Start Tracking';
            } else {
                nextBtn.textContent = 'Next';
            }
        }

        function renderWelcomeStep() {
            return `
                <div class="onboarding-welcome">
                    <div class="logo">
                        <span class="logo-icon">&#10003;</span>
                    </div>
                    <h1>Welcome to Habit Tracker</h1>
                    <p class="subtitle">Build better habits with flexible scheduling</p>

                    <div class="feature-highlights">
                        <div class="feature">
                            <span class="feature-icon">&#9788;</span>
                            <span>Track morning & evening routines</span>
                        </div>
                        <div class="feature">
                            <span class="feature-icon">&#128197;</span>
                            <span>Schedule habits your way - daily, weekly, or custom</span>
                        </div>
                        <div class="feature">
                            <span class="feature-icon">&#128200;</span>
                            <span>See your progress and build streaks</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderHabitSetupStep(type) {
            const habitsList = onboardingHabits[type];
            const icon = type === 'morning' ? '&#9788;' : '&#9790;';
            const title = type === 'morning' ? 'Morning Routine' : 'Evening Routine';

            return `
                <div class="habit-setup">
                    <h2>${icon} Set Up Your ${title}</h2>
                    <p class="setup-subtitle">Select habits to track and customize their schedules</p>

                    <div class="onboarding-habit-list">
                        ${habitsList.map((habit, index) => `
                            <div class="onboarding-habit-item ${habit.selected ? 'selected' : ''}" data-index="${index}">
                                <div class="habit-checkbox-wrapper">
                                    <input type="checkbox" ${habit.selected ? 'checked' : ''}
                                           id="habit-${type}-${index}" data-index="${index}">
                                </div>
                                <input type="text" class="habit-name-input" value="${escapeHtml(habit.name)}"
                                       data-index="${index}" placeholder="Habit name">
                                <button class="schedule-btn" data-index="${index}" data-type="${type}">
                                    ${getScheduleLabel(habit.schedule)}
                                </button>
                            </div>
                        `).join('')}
                    </div>

                    <button class="btn-add-onboarding" id="add-custom-${type}">
                        <span>+ Add Custom Habit</span>
                    </button>
                </div>
            `;
        }

        function attachHabitSetupListeners(type) {
            const habitsList = onboardingHabits[type];

            // Checkbox listeners
            document.querySelectorAll('.onboarding-habit-item input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    habitsList[index].selected = e.target.checked;
                    e.target.closest('.onboarding-habit-item').classList.toggle('selected', e.target.checked);
                });
            });

            // Name input listeners
            document.querySelectorAll('.habit-name-input').forEach(input => {
                input.addEventListener('input', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    habitsList[index].name = e.target.value;
                });
            });

            // Schedule button listeners
            document.querySelectorAll('.schedule-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    openScheduleModal(habitsList[index], (newSchedule) => {
                        habitsList[index].schedule = newSchedule;
                        e.target.textContent = getScheduleLabel(newSchedule);
                    });
                });
            });

            // Add custom habit button
            const addBtn = document.getElementById(`add-custom-${type}`);
            if (addBtn) {
                addBtn.addEventListener('click', () => {
                    habitsList.push({
                        name: '',
                        type: type,
                        order: habitsList.length + 1,
                        selected: true,
                        schedule: { type: 'daily' }
                    });
                    renderOnboardingStep();
                    // Focus the new input
                    setTimeout(() => {
                        const inputs = document.querySelectorAll('.habit-name-input');
                        if (inputs.length > 0) {
                            inputs[inputs.length - 1].focus();
                        }
                    }, 100);
                });
            }
        }

        function renderReviewStep() {
            const morningSelected = onboardingHabits.morning.filter(h => h.selected && h.name.trim());
            const eveningSelected = onboardingHabits.evening.filter(h => h.selected && h.name.trim());

            return `
                <div class="onboarding-review">
                    <div class="success-icon">&#10003;</div>
                    <h2>You're All Set!</h2>
                    <p class="review-subtitle">Here's your habit tracking plan</p>

                    <div class="review-summary">
                        <div class="summary-card">
                            <span class="card-value">${morningSelected.length}</span>
                            <span class="card-label">Morning</span>
                        </div>
                        <div class="summary-card">
                            <span class="card-value">${eveningSelected.length}</span>
                            <span class="card-label">Evening</span>
                        </div>
                    </div>

                    <div class="review-details">
                        ${morningSelected.length > 0 ? `
                            <div class="review-section">
                                <h3>&#9788; Morning Habits</h3>
                                ${morningSelected.map(h => `
                                    <div class="review-habit">
                                        <span>${escapeHtml(h.name)}</span>
                                        <span class="schedule-label">${getScheduleLabel(h.schedule)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        ${eveningSelected.length > 0 ? `
                            <div class="review-section">
                                <h3>&#9790; Evening Habits</h3>
                                ${eveningSelected.map(h => `
                                    <div class="review-habit">
                                        <span>${escapeHtml(h.name)}</span>
                                        <span class="schedule-label">${getScheduleLabel(h.schedule)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        ${morningSelected.length === 0 && eveningSelected.length === 0 ? `
                            <p style="text-align: center; color: var(--text-muted);">No habits selected. You can add them later in Settings.</p>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        async function finishOnboarding() {
            const nextBtn = document.getElementById('onboarding-next');
            nextBtn.disabled = true;
            nextBtn.textContent = 'Saving...';

            try {
                // Save habits to Firestore
                const habitsRef = collection(db, `users/${currentUser.uid}/habits`);

                // Save morning habits
                const morningSelected = onboardingHabits.morning.filter(h => h.selected && h.name.trim());
                for (let i = 0; i < morningSelected.length; i++) {
                    const habit = morningSelected[i];
                    await addDoc(habitsRef, {
                        name: habit.name.trim(),
                        type: 'morning',
                        order: i + 1,
                        schedule: habit.schedule,
                        createdAt: serverTimestamp(),
                        archived: false
                    });
                }

                // Save evening habits
                const eveningSelected = onboardingHabits.evening.filter(h => h.selected && h.name.trim());
                for (let i = 0; i < eveningSelected.length; i++) {
                    const habit = eveningSelected[i];
                    await addDoc(habitsRef, {
                        name: habit.name.trim(),
                        type: 'evening',
                        order: i + 1,
                        schedule: habit.schedule,
                        createdAt: serverTimestamp(),
                        archived: false
                    });
                }

                // Mark onboarding complete
                await completeOnboarding();

                // Transition to dashboard
                subscribeToHabits();
                subscribeToEntry();
                document.getElementById('user-email').textContent = currentUser.email;
                showScreen('dashboard');
                updateDateDisplay();
                renderDashboard();

            } catch (error) {
                console.error('Error finishing onboarding:', error);
                nextBtn.disabled = false;
                nextBtn.textContent = 'Start Tracking';
                alert('Failed to save habits. Please try again.');
            }
        }

        // ========== SCHEDULE MODAL ==========
        function openScheduleModal(habit, callback) {
            currentScheduleHabit = habit;
            currentScheduleCallback = callback;

            const modal = document.getElementById('schedule-modal');
            modal.classList.remove('hidden');

            // Set active type
            const schedule = habit.schedule || { type: 'daily' };
            document.querySelectorAll('.schedule-type-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === schedule.type);
            });

            renderScheduleOptions(schedule);
        }

        function closeScheduleModal() {
            document.getElementById('schedule-modal').classList.add('hidden');
            currentScheduleHabit = null;
            currentScheduleCallback = null;
        }

        function renderScheduleOptions(schedule) {
            const container = document.getElementById('schedule-options');
            const type = schedule.type || 'daily';

            switch (type) {
                case 'daily':
                    container.innerHTML = `
                        <p>This habit will be tracked every day</p>
                    `;
                    break;

                case 'specific_days':
                    const days = schedule.days || [1, 2, 3, 4, 5]; // Default to weekdays
                    container.innerHTML = `
                        <p>Select which days to track this habit</p>
                        <div class="day-selector">
                            ${DAY_NAMES.map((name, i) => `
                                <button class="day-chip ${days.includes(i) ? 'selected' : ''}" data-day="${i}">
                                    ${name.substring(0, 3)}
                                </button>
                            `).join('')}
                        </div>
                    `;
                    // Add click listeners
                    container.querySelectorAll('.day-chip').forEach(chip => {
                        chip.addEventListener('click', () => {
                            chip.classList.toggle('selected');
                        });
                    });
                    break;

                case 'weekly_goal':
                    const times = schedule.timesPerWeek || 3;
                    container.innerHTML = `
                        <p>How many times per week?</p>
                        <div class="weekly-goal-input">
                            <span>Complete</span>
                            <select id="times-per-week">
                                ${[1,2,3,4,5,6,7].map(n => `
                                    <option value="${n}" ${n === times ? 'selected' : ''}>${n}</option>
                                `).join('')}
                            </select>
                            <span>times per week</span>
                        </div>
                    `;
                    break;

                case 'interval':
                    const intervalDays = schedule.intervalDays || 2;
                    container.innerHTML = `
                        <div class="interval-input">
                            <div class="interval-row">
                                <span>Every</span>
                                <input type="number" id="interval-days" min="2" max="30" value="${intervalDays}">
                                <span>days</span>
                            </div>
                        </div>
                    `;
                    break;
            }
        }

        function getScheduleFromModal() {
            const activeType = document.querySelector('.schedule-type-btn.active').dataset.type;
            const schedule = { type: activeType };

            switch (activeType) {
                case 'specific_days':
                    schedule.days = Array.from(document.querySelectorAll('.day-chip.selected'))
                        .map(chip => parseInt(chip.dataset.day));
                    if (schedule.days.length === 0) {
                        schedule.days = [0,1,2,3,4,5,6]; // Default to all days if none selected
                    }
                    break;

                case 'weekly_goal':
                    schedule.timesPerWeek = parseInt(document.getElementById('times-per-week').value) || 3;
                    break;

                case 'interval':
                    schedule.intervalDays = parseInt(document.getElementById('interval-days').value) || 2;
                    schedule.intervalStartDate = formatDate(new Date());
                    break;
            }

            return schedule;
        }

        function showError(message) {
            const loadingContent = document.querySelector('.loading-content');
            if (loadingContent) {
                loadingContent.innerHTML = `
                    <div class="logo" style="background: var(--accent-danger);">
                        <span class="logo-icon">!</span>
                    </div>
                    <h1>Error</h1>
                    <p style="color: var(--text-secondary); margin: 16px 0;">${message}</p>
                    <button onclick="location.reload()" class="btn btn-primary" style="max-width: 150px;">Refresh</button>
                `;
            }
        }

        function renderHabits() {
            const dateString = formatDate(currentDate);
            const scheduled = getScheduledHabitsForDate(habits, dateString);
            const unscheduled = getUnscheduledHabitsForDate(habits, dateString);

            // Render scheduled habits
            renderHabitList('morning-habits', scheduled.morning, 'morning');
            renderHabitList('evening-habits', scheduled.evening, 'evening');

            // Render Not Today section
            renderNotTodaySection(unscheduled);
        }

        function renderHabitList(containerId, habitList, type) {
            const container = document.getElementById(containerId);
            if (!container) return;

            if (habitList.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">${type === 'morning' ? 'ðŸŒ…' : 'ðŸŒ™'}</div>
                        <p>No ${type} habits scheduled</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = habitList.map(habit => `
                <div class="habit-item" data-id="${habit.id}" data-type="${type}">
                    <div class="habit-checkbox"></div>
                    <span class="habit-name">${escapeHtml(habit.name)}</span>
                </div>
            `).join('');

            // Add click handlers
            container.querySelectorAll('.habit-item').forEach(item => {
                item.addEventListener('click', async () => {
                    const habitId = item.dataset.id;
                    const habitType = item.dataset.type;
                    item.classList.add('completing');
                    await toggleHabit(habitId, habitType);
                    setTimeout(() => item.classList.remove('completing'), 300);
                });
            });

            updateHabitCheckmarks();
        }

        function renderNotTodaySection(unscheduled) {
            const section = document.getElementById('not-today-section');
            const container = document.getElementById('not-today-habits');
            const countEl = document.querySelector('.not-today-count');

            const totalUnscheduled = unscheduled.morning.length + unscheduled.evening.length;

            if (totalUnscheduled === 0) {
                section.classList.add('hidden');
                return;
            }

            section.classList.remove('hidden');
            countEl.textContent = `(${totalUnscheduled})`;

            let html = '';

            if (unscheduled.morning.length > 0) {
                html += `
                    <div class="not-today-type">
                        <span class="type-label">&#9788; Morning</span>
                        ${unscheduled.morning.map(habit => `
                            <div class="not-today-habit">
                                <span class="habit-name">${escapeHtml(habit.name)}</span>
                                <span class="schedule-badge">${getScheduleLabel(habit.schedule)}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            if (unscheduled.evening.length > 0) {
                html += `
                    <div class="not-today-type">
                        <span class="type-label">&#9790; Evening</span>
                        ${unscheduled.evening.map(habit => `
                            <div class="not-today-habit">
                                <span class="habit-name">${escapeHtml(habit.name)}</span>
                                <span class="schedule-badge">${getScheduleLabel(habit.schedule)}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        function updateHabitCheckmarks() {
            if (!currentEntry) return;

            document.querySelectorAll('.habit-item').forEach(item => {
                const habitId = item.dataset.id;
                const type = item.dataset.type;
                const completed = currentEntry[type] || [];
                item.classList.toggle('completed', completed.includes(habitId));
            });
        }

        function updateProgress() {
            const habitList = habits[currentTab] || [];
            const completed = currentEntry?.[currentTab] || [];
            const total = habitList.length;
            const done = habitList.filter(h => completed.includes(h.id)).length;
            const percentage = total > 0 ? (done / total) * 100 : 0;

            document.getElementById('progress-fill').style.width = `${percentage}%`;
            document.getElementById('progress-text').textContent = `${done}/${total} completed`;
        }

        function updateDateDisplay() {
            const today = new Date();
            const isToday = formatDate(currentDate) === formatDate(today);
            const dateText = document.querySelector('#current-date .date-text');
            const dateFull = document.querySelector('#current-date .date-full');

            if (isToday) {
                dateText.textContent = 'Today';
            } else {
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                dateText.textContent = formatDate(currentDate) === formatDate(yesterday)
                    ? 'Yesterday'
                    : currentDate.toLocaleDateString('en-US', { weekday: 'short' });
            }

            dateFull.textContent = currentDate.toLocaleDateString('en-US', {
                weekday: 'short', month: 'short', day: 'numeric', year: 'numeric'
            });

            document.getElementById('next-date').disabled = isToday;
            document.getElementById('next-date').style.opacity = isToday ? '0.3' : '1';
        }

        function renderEditableHabits() {
            renderEditableList('edit-morning-habits', habits.morning, 'morning');
            renderEditableList('edit-evening-habits', habits.evening, 'evening');
        }

        function renderEditableList(containerId, habitList, type) {
            const container = document.getElementById(containerId);
            if (!container) return;

            if (habitList.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted);">No habits yet</p>';
                return;
            }

            container.innerHTML = habitList.map(habit => `
                <div class="edit-habit-item" data-id="${habit.id}">
                    <span class="drag-handle">â˜°</span>
                    <span class="edit-habit-name">${escapeHtml(habit.name)}</span>
                    <div class="edit-habit-actions">
                        <button class="edit-btn edit" data-id="${habit.id}" data-type="${type}">âœŽ</button>
                        <button class="edit-btn delete" data-id="${habit.id}">Ã—</button>
                    </div>
                </div>
            `).join('');

            container.querySelectorAll('.edit-btn.edit').forEach(btn => {
                btn.addEventListener('click', () => {
                    const habit = habits[btn.dataset.type].find(h => h.id === btn.dataset.id);
                    if (habit) openHabitModal(habit, btn.dataset.type);
                });
            });

            container.querySelectorAll('.edit-btn.delete').forEach(btn => {
                btn.addEventListener('click', () => openDeleteModal(btn.dataset.id));
            });
        }

        // ========== DASHBOARD ==========
        async function renderDashboard() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();

            // Populate month selector
            const monthSelector = document.getElementById('month-selector');
            monthSelector.innerHTML = '';
            for (let i = 0; i < 12; i++) {
                const d = new Date(year, month - i, 1);
                const option = document.createElement('option');
                option.value = `${d.getFullYear()}-${d.getMonth()}`;
                option.textContent = d.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                if (i === 0) option.selected = true;
                monthSelector.appendChild(option);
            }

            await updateDashboardData(year, month);
        }

        async function updateDashboardData(year, month) {
            const today = new Date();
            const startDate = new Date(year, month, 1);
            const endDate = new Date(year, month + 1, 0);
            const lastDay = (year === today.getFullYear() && month === today.getMonth())
                ? today.getDate()
                : endDate.getDate();

            // Fetch all entries for the month
            const entriesRef = collection(db, `users/${currentUser.uid}/entries`);
            const entriesSnapshot = await getDocs(entriesRef);

            const entriesMap = {};
            entriesSnapshot.forEach(doc => {
                entriesMap[doc.id] = doc.data();
            });

            // Calculate habit completion rates for current type
            const currentType = document.querySelector('.dash-tab.active')?.dataset.type || 'morning';
            const typeHabits = habits[currentType];

            const habitStats = typeHabits.map(habit => {
                let completed = 0;
                let possible = lastDay;

                for (let day = 1; day <= lastDay; day++) {
                    const dateString = formatDate(new Date(year, month, day));
                    const entry = entriesMap[dateString];
                    if (entry && entry[currentType] && entry[currentType].includes(habit.id)) {
                        completed++;
                    }
                }

                // Calculate current streak for this habit
                let currentHabitStreak = 0;
                const todayDate = new Date();
                for (let i = 0; i <= 365; i++) {
                    const checkDate = new Date(todayDate);
                    checkDate.setDate(checkDate.getDate() - i);
                    const dateString = formatDate(checkDate);
                    const entry = entriesMap[dateString];

                    if (entry && entry[currentType]?.includes(habit.id)) {
                        currentHabitStreak++;
                    } else {
                        if (i === 0) continue; // Today not logged yet
                        break;
                    }
                }

                // Calculate best streak for this habit
                let bestHabitStreak = 0;
                let tempHabitStreak = 0;
                for (let i = 0; i < 365; i++) {
                    const checkDate = new Date(todayDate);
                    checkDate.setDate(checkDate.getDate() - i);
                    const dateString = formatDate(checkDate);
                    const entry = entriesMap[dateString];

                    if (entry && entry[currentType]?.includes(habit.id)) {
                        tempHabitStreak++;
                        bestHabitStreak = Math.max(bestHabitStreak, tempHabitStreak);
                    } else {
                        tempHabitStreak = 0;
                    }
                }

                return {
                    habit,
                    completed,
                    possible,
                    rate: possible > 0 ? Math.round((completed / possible) * 100) : 0,
                    currentStreak: currentHabitStreak,
                    bestStreak: bestHabitStreak
                };
            });

            // Render habit rates
            const ratesContainer = document.getElementById('habit-rates');
            if (typeHabits.length === 0) {
                ratesContainer.innerHTML = '<p style="color: var(--text-muted);">No habits to display</p>';
            } else {
                ratesContainer.innerHTML = habitStats.map(stat => `
                    <div class="rate-item">
                        <div class="rate-header">
                            <span class="rate-label">${escapeHtml(stat.habit.name)}</span>
                            <div class="rate-streaks">
                                <span class="streak-badge" title="Current streak">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"></path>
                                    </svg>
                                    ${stat.currentStreak} days
                                </span>
                                <span class="streak-badge best" title="Best streak">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                                    </svg>
                                    ${stat.bestStreak} days
                                </span>
                            </div>
                        </div>
                        <div class="rate-bar-container">
                            <div class="rate-bar">
                                <div class="rate-fill" style="width: ${stat.rate}%"></div>
                            </div>
                            <span class="rate-value">${stat.rate}%</span>
                        </div>
                    </div>
                `).join('');
            }

            // Render completion chart
            renderCompletionChart(year, month, lastDay, entriesMap);

            // Calculate overall completion rate
            let totalCompleted = 0;
            let totalPossible = 0;
            const allHabits = [...habits.morning, ...habits.evening];

            for (let day = 1; day <= lastDay; day++) {
                const dateString = formatDate(new Date(year, month, day));
                const entry = entriesMap[dateString];

                allHabits.forEach(habit => {
                    totalPossible++;
                    const type = habit.type;
                    if (entry && entry[type] && entry[type].includes(habit.id)) {
                        totalCompleted++;
                    }
                });
            }

            const overallRate = totalPossible > 0 ? Math.round((totalCompleted / totalPossible) * 100) : 0;
            document.getElementById('overall-rate').textContent = `${overallRate}%`;

            // Calculate streaks
            let currentStreak = 0;
            let bestStreak = 0;
            let tempStreak = 0;

            const todayDate = new Date();
            for (let i = 0; i <= 365; i++) {
                const checkDate = new Date(todayDate);
                checkDate.setDate(checkDate.getDate() - i);
                const dateString = formatDate(checkDate);
                const entry = entriesMap[dateString];

                if (!entry) {
                    if (i === 0) continue; // Today not logged yet
                    if (currentStreak === 0) currentStreak = tempStreak;
                    tempStreak = 0;
                    continue;
                }

                const morningComplete = habits.morning.length > 0
                    ? habits.morning.every(h => entry.morning?.includes(h.id))
                    : true;
                const eveningComplete = habits.evening.length > 0
                    ? habits.evening.every(h => entry.evening?.includes(h.id))
                    : true;

                if (morningComplete && eveningComplete) {
                    tempStreak++;
                    bestStreak = Math.max(bestStreak, tempStreak);
                } else {
                    if (currentStreak === 0) currentStreak = tempStreak;
                    tempStreak = 0;
                }
            }

            if (currentStreak === 0) currentStreak = tempStreak;

            document.getElementById('current-streak').textContent = currentStreak;
            document.getElementById('best-streak').textContent = bestStreak;

            // Render calendar with real data
            renderCalendar(year, month, entriesMap);
        }

        function renderCalendar(year, month, entriesMap) {
            const container = document.getElementById('calendar-heatmap');
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDayOfWeek = firstDay.getDay();
            const today = formatDate(new Date());

            const weekdays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            let html = '<div class="calendar-weekdays">';
            weekdays.forEach(day => {
                html += `<span class="weekday-label">${day}</span>`;
            });
            html += '</div><div class="calendar-heatmap">';

            // Empty cells before first day
            for (let i = 0; i < startDayOfWeek; i++) {
                html += '<div class="calendar-day empty"></div>';
            }

            const allHabits = [...habits.morning, ...habits.evening];
            const totalHabitsCount = allHabits.length;

            // Days of month
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dateString = formatDate(new Date(year, month, day));
                const isToday = dateString === today;
                const entry = entriesMap[dateString];

                let completedCount = 0;
                if (entry) {
                    allHabits.forEach(habit => {
                        const type = habit.type;
                        if (entry[type] && entry[type].includes(habit.id)) {
                            completedCount++;
                        }
                    });
                }

                const completionRate = totalHabitsCount > 0 ? completedCount / totalHabitsCount : 0;
                let level = 0;
                if (completionRate >= 1) level = 5;
                else if (completionRate >= 0.8) level = 4;
                else if (completionRate >= 0.6) level = 3;
                else if (completionRate >= 0.4) level = 2;
                else if (completionRate > 0) level = 1;

                html += `<div class="calendar-day level-${level} ${isToday ? 'today' : ''}">${day}</div>`;
            }

            html += '</div>';
            container.innerHTML = html;
        }

        // Global chart instance
        let completionChartInstance = null;

        function renderCompletionChart(year, month, lastDay, entriesMap) {
            const canvas = document.getElementById('completion-chart');
            if (!canvas) return;

            const labels = [];
            const data = [];
            const allHabits = [...habits.morning, ...habits.evening];
            const totalHabitsCount = allHabits.length;

            if (totalHabitsCount === 0) {
                // No habits, hide chart
                if (completionChartInstance) {
                    completionChartInstance.destroy();
                    completionChartInstance = null;
                }
                return;
            }

            // Calculate completion percentage for each day
            for (let day = 1; day <= lastDay; day++) {
                const dateString = formatDate(new Date(year, month, day));
                const entry = entriesMap[dateString];

                labels.push(day);

                let completedCount = 0;
                if (entry) {
                    allHabits.forEach(habit => {
                        const type = habit.type;
                        if (entry[type] && entry[type].includes(habit.id)) {
                            completedCount++;
                        }
                    });
                }

                const percentage = Math.round((completedCount / totalHabitsCount) * 100);
                data.push(percentage);
            }

            // Destroy existing chart if it exists
            if (completionChartInstance) {
                completionChartInstance.destroy();
            }

            // Create new chart
            const ctx = canvas.getContext('2d');
            completionChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Completion %',
                        data,
                        borderColor: '#ffffff',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        fill: false,
                        tension: 0, // Brutalist: sharp lines
                        pointRadius: 0,
                        pointHoverRadius: 6,
                        pointBackgroundColor: '#ffffff',
                        pointBorderColor: '#000000',
                        pointBorderWidth: 2,
                        pointHoverBackgroundColor: '#6a00ff', // Electric Purple
                        pointHoverBorderColor: '#ffffff',
                        pointHoverBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: '#000000',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: '#ffffff',
                            borderWidth: 2,
                            padding: 12,
                            cornerRadius: 0, // Brutalist: no rounded corners
                            displayColors: false,
                            titleFont: {
                                family: 'Courier New'
                            },
                            bodyFont: {
                                family: 'Courier New'
                            },
                            callbacks: {
                                title: (context) => {
                                    const day = context[0].label;
                                    const monthName = new Date(year, month, day).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                    return monthName.toUpperCase();
                                },
                                label: (context) => {
                                    return `${context.parsed.y}% COMPLETED`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: '#333333',
                                drawBorder: false,
                                tickColor: '#ffffff'
                            },
                            ticks: {
                                color: '#ffffff',
                                font: {
                                    family: 'Courier New',
                                    size: 10,
                                    weight: 'bold'
                                },
                                maxRotation: 0,
                                autoSkip: true,
                                maxTicksLimit: 10
                            }
                        },
                        y: {
                            min: 0,
                            max: 100,
                            grid: {
                                color: '#333333',
                                drawBorder: false,
                                tickColor: '#ffffff'
                            },
                            ticks: {
                                color: '#ffffff',
                                font: {
                                    family: 'Courier New',
                                    size: 10,
                                    weight: 'bold'
                                },
                                callback: (value) => value + '%'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        // ========== TODAY CALENDAR ==========
        async function renderTodayCalendar() {
            const monthDate = new Date(calendarState.currentYear, calendarState.currentMonth, 1);
            const lastDay = new Date(calendarState.currentYear, calendarState.currentMonth + 1, 0);
            const startDayOfWeek = monthDate.getDay();
            const today = formatDate(new Date());
            const selectedString = formatDate(currentDate);

            // Update month label
            document.getElementById('calendar-month-year').textContent = monthDate.toLocaleDateString('en-US', {
                month: 'long',
                year: 'numeric'
            });

            // Fetch entries for this month
            const entriesRef = collection(db, `users/${currentUser.uid}/entries`);
            const entriesSnapshot = await getDocs(entriesRef);
            const entriesMap = {};
            entriesSnapshot.forEach(doc => {
                entriesMap[doc.id] = doc.data();
            });
            calendarState.entriesData = entriesMap;

            // Build calendar grid
            const allHabits = [...habits.morning, ...habits.evening];
            const totalHabits = allHabits.length;
            const days = [];

            // Empty cells before first day
            for (let i = 0; i < startDayOfWeek; i++) {
                days.push('<button class="calendar-day-btn empty" disabled></button>');
            }

            // Days of the month
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dateString = formatDate(new Date(calendarState.currentYear, calendarState.currentMonth, day));
                const entry = entriesMap[dateString];
                const isToday = dateString === today;
                const isSelected = dateString === selectedString;
                const isFuture = new Date(dateString) > new Date();

                let classes = 'calendar-day-btn';
                if (isToday) classes += ' today';
                if (isSelected) classes += ' selected';

                // Add data indicator
                if (entry && totalHabits > 0) {
                    let completedCount = 0;
                    allHabits.forEach(habit => {
                        const type = habit.type;
                        if (entry[type] && entry[type].includes(habit.id)) {
                            completedCount++;
                        }
                    });

                    if (completedCount === totalHabits) {
                        classes += ' has-data';
                    } else if (completedCount > 0) {
                        classes += ' partial-data';
                    }
                }

                days.push(`
                    <button
                        class="${classes}"
                        data-date="${dateString}"
                        ${isFuture ? 'disabled' : ''}
                        onclick="selectCalendarDate('${dateString}')"
                    >
                        ${day}
                    </button>
                `);
            }

            document.getElementById('calendar-days').innerHTML = days.join('');

            // Disable next month if it's in the future
            const nextMonth = new Date(calendarState.currentYear, calendarState.currentMonth + 1, 1);
            const thisMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('next-month').disabled = nextMonth.getTime() > thisMonth.getTime();
        }

        function selectCalendarDate(dateString) {
            // Fix: Parse manually to avoid UTC timezone shift
            const [y, m, d] = dateString.split('-').map(Number);
            currentDate = new Date(y, m - 1, d);
            
            updateDateDisplay();
            subscribeToEntry();

            // Close calendar
            if (calendarState.isOpen) {
                calendarState.isOpen = false;
                document.getElementById('calendar-picker').classList.add('hidden');
                document.getElementById('toggle-calendar').classList.remove('active');
            }
        }

        // Make selectCalendarDate globally accessible
        window.selectCalendarDate = selectCalendarDate;

        // ========== MODALS ==========
        let habitToEdit = null;
        let habitToDelete = null;

        function openHabitModal(habit, type) {
            habitToEdit = habit;
            document.getElementById('habit-id').value = habit?.id || '';
            document.getElementById('habit-type').value = type;
            document.getElementById('habit-name').value = habit?.name || '';
            document.getElementById('modal-title').textContent = habit ? 'Edit Habit' : 'Add Habit';

            // Set schedule
            const schedule = habit?.schedule || { type: 'daily' };
            document.getElementById('habit-schedule').value = JSON.stringify(schedule);
            document.getElementById('habit-schedule-btn').textContent = getScheduleLabel(schedule);

            document.getElementById('habit-modal').classList.remove('hidden');
            document.getElementById('habit-name').focus();
        }

        function closeHabitModal() {
            habitToEdit = null;
            document.getElementById('habit-modal').classList.add('hidden');
            document.getElementById('habit-form').reset();
        }

        function openDeleteModal(habitId) {
            habitToDelete = habitId;
            document.getElementById('delete-modal').classList.remove('hidden');
        }

        function closeDeleteModal() {
            habitToDelete = null;
            document.getElementById('delete-modal').classList.add('hidden');
        }

        // ========== UTILITIES ==========
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ========== EVENT LISTENERS ==========
        document.addEventListener('DOMContentLoaded', () => {
            // Toggle between magic link and password authentication
            let usePassword = true;

            document.getElementById('toggle-auth-method').addEventListener('click', () => {
                usePassword = !usePassword;
                const passwordGroup = document.getElementById('password-group');
                const passwordInput = document.getElementById('password-input');
                const toggleText = document.getElementById('toggle-text');
                const magicLinkBtn = document.getElementById('magic-link-btn');
                const passwordButtons = document.getElementById('password-buttons');

                if (usePassword) {
                    passwordGroup.style.display = 'block';
                    passwordInput.required = true;
                    toggleText.textContent = 'Use magic link instead';
                    magicLinkBtn.style.display = 'none';
                    passwordButtons.style.display = 'flex';
                } else {
                    passwordGroup.style.display = 'none';
                    passwordInput.required = false;
                    passwordInput.value = '';
                    toggleText.textContent = 'Use password instead';
                    magicLinkBtn.style.display = 'block';
                    passwordButtons.style.display = 'none';
                }
            });

            // Magic Link form submission
            document.getElementById('auth-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('email-input').value.trim();
                const btn = document.getElementById('magic-link-btn');

                btn.disabled = true;
                btn.innerHTML = '<span>Sending...</span>';

                try {
                    await sendMagicLink(email);
                    document.getElementById('auth-form').classList.add('hidden');
                    document.getElementById('auth-message').classList.remove('hidden');
                    document.getElementById('sent-email').textContent = email;
                } catch (error) {
                    console.error('Auth error:', error);
                    let errorMsg = 'Failed to send email. ';
                    if (error.code === 'auth/quota-exceeded') {
                        errorMsg = 'Daily quota exceeded. Please use password authentication instead.';
                    } else if (error.code === 'auth/operation-not-allowed') {
                        errorMsg = 'Email link sign-in is not enabled. Please enable it in Firebase Console.';
                    } else if (error.code === 'auth/invalid-email') {
                        errorMsg = 'Please enter a valid email address.';
                    } else if (error.code === 'auth/missing-continue-uri') {
                        errorMsg = 'Configuration error. Missing continue URL.';
                    } else if (error.code === 'auth/unauthorized-continue-uri') {
                        errorMsg = 'This domain is not authorized. Add localhost to Firebase authorized domains.';
                    } else if (error.message) {
                        errorMsg = error.message;
                    }
                    document.getElementById('auth-error').textContent = errorMsg;
                    document.getElementById('auth-error').classList.remove('hidden');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '<span>Send Magic Link</span>';
                }
            });

            // Sign In button handler
            document.getElementById('signin-btn').addEventListener('click', async () => {
                const email = document.getElementById('email-input').value.trim();
                const password = document.getElementById('password-input').value;
                const btn = document.getElementById('signin-btn');

                if (!email || !password) {
                    document.getElementById('auth-error').textContent = 'Please enter email and password.';
                    document.getElementById('auth-error').classList.remove('hidden');
                    return;
                }

                btn.disabled = true;
                btn.innerHTML = '<span>Signing in...</span>';
                document.getElementById('auth-error').classList.add('hidden');

                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    // Success - handleAuthStateChange will be triggered automatically
                } catch (error) {
                    console.error('Sign in error:', error);
                    let errorMsg = 'Sign in failed. ';
                    if (error.code === 'auth/invalid-credential' ||
                        error.code === 'auth/user-not-found' ||
                        error.code === 'auth/wrong-password') {
                        errorMsg = 'Invalid email or password. Please try again or sign up.';
                    } else if (error.code === 'auth/invalid-email') {
                        errorMsg = 'Please enter a valid email address.';
                    } else if (error.code === 'auth/too-many-requests') {
                        errorMsg = 'Too many failed attempts. Please try again later.';
                    } else if (error.message) {
                        errorMsg = error.message;
                    }
                    document.getElementById('auth-error').textContent = errorMsg;
                    document.getElementById('auth-error').classList.remove('hidden');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '<span>Sign In</span>';
                }
            });

            // Sign Up button handler
            document.getElementById('signup-btn').addEventListener('click', async () => {
                const email = document.getElementById('email-input').value.trim();
                const password = document.getElementById('password-input').value;
                const btn = document.getElementById('signup-btn');

                if (!email || !password) {
                    document.getElementById('auth-error').textContent = 'Please enter email and password.';
                    document.getElementById('auth-error').classList.remove('hidden');
                    return;
                }

                btn.disabled = true;
                btn.innerHTML = '<span>Creating account...</span>';
                document.getElementById('auth-error').classList.add('hidden');

                try {
                    await createUserWithEmailAndPassword(auth, email, password);
                    // Success - handleAuthStateChange will be triggered automatically
                } catch (error) {
                    console.error('Sign up error:', error);
                    let errorMsg = 'Sign up failed. ';
                    if (error.code === 'auth/email-already-in-use') {
                        errorMsg = 'Email already registered. Please sign in instead.';
                    } else if (error.code === 'auth/weak-password') {
                        errorMsg = 'Password must be at least 6 characters.';
                    } else if (error.code === 'auth/invalid-email') {
                        errorMsg = 'Please enter a valid email address.';
                    } else if (error.message) {
                        errorMsg = error.message;
                    }
                    document.getElementById('auth-error').textContent = errorMsg;
                    document.getElementById('auth-error').classList.remove('hidden');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '<span>Sign Up</span>';
                }
            });

            document.getElementById('try-again').addEventListener('click', () => {
                document.getElementById('auth-form').classList.remove('hidden');
                document.getElementById('auth-message').classList.add('hidden');
                document.getElementById('email-input').value = '';
            });

            // Date navigation
            // Calendar toggle
            document.getElementById('toggle-calendar').addEventListener('click', () => {
                calendarState.isOpen = !calendarState.isOpen;
                const picker = document.getElementById('calendar-picker');
                picker.classList.toggle('hidden', !calendarState.isOpen);
                document.getElementById('toggle-calendar').classList.toggle('active', calendarState.isOpen);

                if (calendarState.isOpen) {
                    calendarState.currentMonth = currentDate.getMonth();
                    calendarState.currentYear = currentDate.getFullYear();
                    renderTodayCalendar();
                }
            });

            // Go to today button
            document.getElementById('today-btn').addEventListener('click', () => {
                currentDate = new Date();
                updateDateDisplay();
                subscribeToEntry();
                if (calendarState.isOpen) {
                    calendarState.isOpen = false;
                    document.getElementById('calendar-picker').classList.add('hidden');
                    document.getElementById('toggle-calendar').classList.remove('active');
                }
            });

            // Previous Day
            document.getElementById('prev-date').addEventListener('click', () => {
                currentDate.setDate(currentDate.getDate() - 1);
                updateDateDisplay();
                subscribeToEntry();
            });

            // Next Day
            document.getElementById('next-date').addEventListener('click', () => {
                const today = new Date();
                // Check if currentDate is strictly before today (ignoring time)
                const isToday = formatDate(currentDate) === formatDate(today);
                
                if (!isToday) {
                    currentDate.setDate(currentDate.getDate() + 1);
                    updateDateDisplay();
                    subscribeToEntry();
                }
            });

            // Calendar month navigation
            document.getElementById('prev-month').addEventListener('click', () => {
                calendarState.currentMonth--;
                if (calendarState.currentMonth < 0) {
                    calendarState.currentMonth = 11;
                    calendarState.currentYear--;
                }
                renderTodayCalendar();
            });

            document.getElementById('next-month').addEventListener('click', () => {
                calendarState.currentMonth++;
                if (calendarState.currentMonth > 11) {
                    calendarState.currentMonth = 0;
                    calendarState.currentYear++;
                }
                renderTodayCalendar();
            });

            // Tab navigation
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentTab = btn.dataset.tab;
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b === btn));
                    document.getElementById('morning-habits').classList.toggle('active', currentTab === 'morning');
                    document.getElementById('evening-habits').classList.toggle('active', currentTab === 'evening');
                    updateProgress();
                });
            });

            // Bottom navigation
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const view = btn.dataset.view;
                    document.querySelectorAll('.nav-btn').forEach(b => b.classList.toggle('active', b.dataset.view === view));

                    if (view === 'today') showScreen('main');
                    else if (view === 'dashboard') {
                        showScreen('dashboard');
                        renderDashboard();
                    }
                    else if (view === 'settings') showScreen('settings');
                });
            });

            // Dashboard tabs
            document.querySelectorAll('.dash-tab').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.dash-tab').forEach(b => b.classList.toggle('active', b === btn));
                    renderDashboard();
                });
            });

            // Add habit buttons
            document.getElementById('add-morning-habit').addEventListener('click', () => openHabitModal(null, 'morning'));
            document.getElementById('add-evening-habit').addEventListener('click', () => openHabitModal(null, 'evening'));

            // Habit modal
            document.getElementById('habit-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('habit-id').value;
                const type = document.getElementById('habit-type').value;
                const name = document.getElementById('habit-name').value.trim();
                const schedule = JSON.parse(document.getElementById('habit-schedule').value);

                if (!name) return;

                try {
                    if (id) {
                        await updateHabit(id, name, schedule);
                    } else {
                        await addHabit(name, type, schedule);
                    }
                    closeHabitModal();
                } catch (error) {
                    console.error('Error saving habit:', error);
                    alert('Failed to save habit.');
                }
            });

            document.getElementById('cancel-habit').addEventListener('click', closeHabitModal);
            document.querySelector('#habit-modal .modal-overlay').addEventListener('click', closeHabitModal);

            // Schedule picker in habit modal
            document.getElementById('habit-schedule-btn').addEventListener('click', () => {
                const currentSchedule = JSON.parse(document.getElementById('habit-schedule').value);
                openScheduleModal({ schedule: currentSchedule }, (newSchedule) => {
                    document.getElementById('habit-schedule').value = JSON.stringify(newSchedule);
                    document.getElementById('habit-schedule-btn').textContent = getScheduleLabel(newSchedule);
                });
            });

            // Delete modal
            document.getElementById('confirm-delete').addEventListener('click', async () => {
                if (habitToDelete) {
                    try {
                        await deleteHabit(habitToDelete);
                        closeDeleteModal();
                    } catch (error) {
                        console.error('Error deleting habit:', error);
                        alert('Failed to delete habit.');
                    }
                }
            });

            document.getElementById('cancel-delete').addEventListener('click', closeDeleteModal);
            document.querySelector('#delete-modal .modal-overlay').addEventListener('click', closeDeleteModal);

            // Logout
            document.getElementById('logout-btn').addEventListener('click', logout);

            // Offline indicator
            window.addEventListener('online', () => document.getElementById('offline-indicator').classList.add('hidden'));
            window.addEventListener('offline', () => document.getElementById('offline-indicator').classList.remove('hidden'));

            // Onboarding navigation
            document.getElementById('onboarding-next').addEventListener('click', () => {
                if (onboardingStep < 4) {
                    onboardingStep++;
                    renderOnboardingStep();
                } else {
                    finishOnboarding();
                }
            });

            document.getElementById('onboarding-back').addEventListener('click', () => {
                if (onboardingStep > 1) {
                    onboardingStep--;
                    renderOnboardingStep();
                }
            });

            document.getElementById('onboarding-skip').addEventListener('click', () => {
                // Skip to review step
                onboardingStep = 4;
                renderOnboardingStep();
            });

            // Schedule modal
            document.querySelectorAll('.schedule-type-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.schedule-type-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    renderScheduleOptions({ type: btn.dataset.type });
                });
            });

            document.getElementById('save-schedule').addEventListener('click', () => {
                const schedule = getScheduleFromModal();
                if (currentScheduleCallback) {
                    currentScheduleCallback(schedule);
                }
                closeScheduleModal();
            });

            document.getElementById('cancel-schedule').addEventListener('click', closeScheduleModal);
            document.querySelector('#schedule-modal .modal-overlay').addEventListener('click', closeScheduleModal);

            // Not Today section toggle
            document.getElementById('toggle-not-today').addEventListener('click', () => {
                const section = document.getElementById('not-today-section');
                section.classList.toggle('collapsed');
            });

            // Start the app
            init();
        });
    </script>

    <!-- Register Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('Service Worker registered'))
                    .catch(err => console.log('Service Worker registration failed:', err));
            });
        }
    </script>
</body>
</html>
